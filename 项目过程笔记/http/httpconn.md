# http/httpconn.h、http/httpconn.cpp

## 使用库

* arpa/inet.h 头文件, Internet操作的定义

```C++
#include <arpa/inet.h>

// sockaddr_in 结构体，用来处理网络通信的地址。
struct sockaddr_in {
    sa_family_t    sin_family; /* address family: AF_INET */
    in_port_t      sin_port;   /* port in network byte order */
    struct in_addr sin_addr;   /* internet address */
};
```

* arpa/inet.h 头文件，互联网地址操纵函数库

```C++
#include <arpa/inet.h>

// inet_ntoa 函数，将Internet主机地址转换为:以网络字节顺序给出，转换为IPv4点分十进制字符串。字符串以静态分配的方式返回在缓冲区，后续调用将覆盖它。
char *inet_ntoa(struct in_addr in);

```

* 其他

c++ 静态变量，经常会放到cpp文件中初始化。但并非一定要放到cpp中初始化.

之所以需要放到cpp中初始化，是因为static变量，必需切只能一次被初始化。

如果放到头文件.h中，两个cpp都include了.h文件，那就变成了"multiple definition"。但是如果只会被include一次，放到.h中是可以编译通过的。

问题的核心在于 *必需且只能一次被初始化*

## 笔记

一个Http连接的类，此类的一个对象就是一个http连接。

构造函数：初始化fd_为-1，addr_为空，is_close_为true，连接为关闭状态

析构函数：调用Close关闭连接

私有成员变量：

* fd_：套接字的文件描述符（Linux所有为文件），用于网络读写
* addr_：客户的连接地址信息
* is_close_：标识此连接是否关闭
* iov_cnt_：iov的通道个数，1或者2
* iov_：两个通道，第一个指向写缓冲区顶部（待发送的起始地址），第二个指向要响应的文件内容再内存映射的起始地址（如果需要）
* read_buff_：该连接的写缓冲区
* write_buff_：该连接的读缓冲区
* request_：由于解析请求的对象
* response_：用于进行响应的对象

公有成员变量：

* isET: 表示是否是ET模式
* src_dir：记录资源的目录路径
* user_count：表示当前用几个用户连接的静态成员，使用atomic类型进行原子性访问user_count

公有成员函数：

Init：初始化连接，入参为套接字的文件描述符合客户端地址

* 连接用户+1，设置客户地址，设置套接字文件描述符，清空读缓重区和写缓冲区，设置打开标识，写入日志

Read：将套接字的内容（即请求的内容）读入读缓存区，并设置错误码（如果出错）

* 循环读取，直到读取的长度小于0（读取完毕）

Write：将写缓存区的内容以及映射到内存的请求内容（如果有的话）从套接字发送给客户端

* 循环向套接字写入，知道待写入的字节数为为0
  * 如果要发送的长度为0，传输结束
  * 如果写入长度大于第一个通道（写缓冲区写入长度），说明写缓冲区写完。
    * 将第二个通道（响应文件在内存的映射）的起点向后移动到还未传输的地方
    * 将第二个通道待传输的内容长度减去已经传输的，即记下还要传输的内容长度
    * 将第一个通道的传输长度置为0，清空写缓冲区
  * 如果写入长度小于等于第一个通道（写缓冲区写入长度），说明写缓冲区还没写完。
    * 第一个通道位置向后移动已写的长度
    * 第一个通道待写的长度减去已写的长度
    * 写缓冲区已读标识向后移动已写长度

Close：关闭一个当前用户的连接

* 删除响应文件在内存中的映射
* 如果连接是开启状态，则置为关闭状态，用户数减1，关闭套接字，记下日志

GetFd：返回套接字文件描述符，即返回成员变量fd_

GetPort：返回客户端的端口号，即从地址结构体中取出端口号

GetIP：返回客户端的ip地址，即利用库函数提取地址中的ip

GetAddr：返回客户端地址信息，即返回成员变量addr_

Process：处理http请求，并根据请求处理好响应内容，将待写入套接字的通道接入对应位置（第一个为写缓冲区，第二个为响应内容内存的映射

* 如果请求处于结束（上一个请求结束）状态，初始化请求对象
* 如果读缓冲区为空，说明没有从套接字读入数据，返回false
* 如果是get请求，用解析出的请求路径初始化响应（src_dir在服务器主类中初始化）
* 如果解析出没有请求，直接返回，否则用400错误号初始化响应对象
* 向写缓冲区写入响应内容
* 将通道1指向写缓冲区顶部（待读取的位置），将写入内容长度置为写缓冲区可读内容
* 如果响应的文件长度大于0，将通道2指向响应的文件在内存映射的起始位置，长度置为文件大小，并将通道数置为2

ToWriteBytes：待发送给套接字的字节数

IsKeepAlive：从请求中获取该请求是否是长连接
